name: Check Updates

on:
  schedule:
    - cron: "0 6 * * 0"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no PRs created)"
        type: boolean
        default: false
      package:
        description: "Specific package to check (e.g., net-im/goofcord)"
        type: string
        required: false

permissions:
  contents: write
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GIT_TERMINAL_PROMPT: "0"

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      updates_json: ${{ steps.check.outputs.updates }}
      has_updates: ${{ steps.check.outputs.has_updates }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
        with:
          version: "latest"

      - name: Check for updates
        id: check
        env:
          PACKAGE: ${{ inputs.package }}
        run: |
          ARGS=""
          if [ -n "$PACKAGE" ]; then
            ARGS="--package $PACKAGE"
          fi

          .opencode/skill/overlay-tools/bin/check-updates $ARGS --json > updates.json 2>/dev/null || true

          echo "Updates found:"
          cat updates.json | jq -r '.[] | select(.status=="update-available") | "\(.category)/\(.name): \(.current_version) -> \(.latest_version)"'

          HAS_UPDATES=$(jq 'any(.[]; .status=="update-available")' updates.json)
          echo "has_updates=$HAS_UPDATES" >> "$GITHUB_OUTPUT"

          UPDATES=$(cat updates.json | jq -c '[.[] | select(.status=="update-available")]')
          echo "updates=$UPDATES" >> "$GITHUB_OUTPUT"

      - name: Upload updates artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: updates
          path: updates.json

  create-prs:
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true' && github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    container:
      image: gentoo/stage3:latest
      options: --user root
    env:
      PORTAGE_BINHOST: "https://distfiles.gentoo.org/releases/amd64/binpackages/23.0/x86-64/"
      EMERGE_DEFAULT_OPTS: "--getbinpkg=y --usepkg=y --binpkg-respect-use=y"
    strategy:
      fail-fast: false
      matrix:
        update: ${{ fromJson(needs.check-updates.outputs.updates_json) }}

    steps:
      - name: Install dependencies
        run: |
          emerge-webrsync
          emerge --quiet --noreplace dev-vcs/git app-misc/ca-certificates net-misc/curl
          emerge --info | grep -E "(BINHOST|EMERGE_DEFAULT_OPTS|FEATURES)" || true

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7
        with:
          version: "latest"

      - name: Install gh
        env:
          GH_VERSION: "2.45.0"
        run: |
          curl -fsSL -o /tmp/gh.tar.gz "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz"
          tar -C /tmp -xzf /tmp/gh.tar.gz
          install -m 0755 "/tmp/gh_${GH_VERSION}_linux_amd64/bin/gh" /usr/local/bin/gh

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create PR for ${{ matrix.update.category }}/${{ matrix.update.name }}
        env:
          CATEGORY: ${{ matrix.update.category }}
          NAME: ${{ matrix.update.name }}
          VERSION: ${{ matrix.update.latest_version }}
          MY_PV: ${{ matrix.update.my_pv }}
          UPSTREAM_URL: ${{ matrix.update.latest_url }}
        run: |
          ATOM="${CATEGORY}/${NAME}"
          echo "Processing $ATOM -> $VERSION"

          ARGS=("--pr" "--base" "master" "--version" "$VERSION")

          if [ -n "$MY_PV" ] && [ "$MY_PV" != "null" ]; then
            ARGS+=("--my-pv" "$MY_PV")
          fi

          if [ -n "$UPSTREAM_URL" ] && [ "$UPSTREAM_URL" != "null" ]; then
            ARGS+=("--upstream-url" "$UPSTREAM_URL")
          fi

          echo "Running: update-ebuild ${ARGS[*]} $ATOM"

          .opencode/skill/overlay-tools/bin/update-ebuild "${ARGS[@]}" "$ATOM" || {
            echo "::warning::Failed to create PR for $ATOM"
            exit 0
          }

  summary:
    needs: [check-updates, create-prs]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        env:
          HAS_UPDATES: ${{ needs.check-updates.outputs.has_updates }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "## Update Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HAS_UPDATES" == "true" ]; then
            if [ "$DRY_RUN" == "true" ]; then
              echo "Updates were found but this was a dry run; PRs were not created." >> $GITHUB_STEP_SUMMARY
            else
              echo "Updates were found and PRs were created (or already exist)." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No updates available. All packages are up to date." >> $GITHUB_STEP_SUMMARY
          fi
